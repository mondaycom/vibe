name: Release new version

on: []

jobs:
  validate-branch:
    name: Validate Branch
    runs-on: ubuntu-latest
    steps:
      - name: Ensure running on master
        if: github.ref != 'refs/heads/master'
        run: |
          echo "::error::Release workflow must be triggered from master branch. Current branch: ${{ github.ref }}"
          exit 1

  notify-release-start:
    name: Notify Slack - Release Started
    needs: validate-branch
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Send Slack notification
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.SLACK_DEV_TEAM_WEBHOOK_URL }}
          method: "POST"
          contentType: "application/json"
          data: |
            {
              "event": "release_started",
              "actor": "${{ github.actor }}",
              "commit_id": "${{ github.sha }}",
              "workflow": "${{ github.workflow }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            }

  build:
    name: Build
    needs: validate-branch
    uses: ./.github/workflows/build-and-upload.yml
    secrets:
      npm_token: ${{ secrets.npm_token }}

  test:
    name: Test
    needs: build
    uses: ./.github/workflows/test.yml
    with:
      has_changes: ${{ needs.build.outputs.has_changes }}
    secrets:
      npm_token: ${{ secrets.npm_token }}

  release:
    name: Release
    needs: [build, test]
    if: ${{ needs.build.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.npm_token }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.VIBE_GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Run Setup
        uses: ./.github/actions/setup
        with:
          npm_token: ${{ secrets.npm_token }}
      - uses: ./.github/actions/git-creds
      - uses: ./.github/actions/download-builds
      - name: Generate new versions
        run: yarn lerna version --exact --conventional-commits --conventional-graduate --message "Publish [skip ci]" -y --create-release github
        env:
          GH_TOKEN: ${{ secrets.VIBE_GITHUB_TOKEN }}
      - run: yarn config set registry https://registry.npmjs.org/
      - name: Setup .npmrc for publish
        id: setup-npmrc
        run: echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" > .npmrc
      - name: Publish to npm
        run: yarn lerna publish from-package -y
      - name: Remove .npmrc
        if: steps.setup-npmrc.outcome == 'success'
        run: rm .npmrc
